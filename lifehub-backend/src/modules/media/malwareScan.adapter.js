export async function scanFile({ fileId, storagePath, fileType, fileName }) {
  const endpoint = process.env.MALWARE_SCAN_ENDPOINT;

  if (!endpoint) {
    const blocked = new Set(["exe", "msi", "bat", "cmd", "sh"]);
    const unsafe = blocked.has(String(fileType || "").toLowerCase());
    return {
      verdict: unsafe ? "MALICIOUS" : "CLEAN",
      engine: "local-fallback"
    };
  }

  const res = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(process.env.MALWARE_SCAN_TOKEN
        ? { Authorization: `Bearer ${process.env.MALWARE_SCAN_TOKEN}` }
        : {})
    },
    body: JSON.stringify({
      fileId: String(fileId),
      storagePath,
      fileType,
      fileName
    })
  });

  if (!res.ok) {
    throw new Error(`Malware scan request failed: ${res.status}`);
  }

  const data = await res.json().catch(() => ({}));
  return {
    verdict: String(data.verdict || "UNKNOWN").toUpperCase(),
    engine: data.engine || "external"
  };
}
